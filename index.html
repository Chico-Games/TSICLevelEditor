<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSIC Level Editor</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Top Toolbar -->
    <div id="toolbar">
        <div class="toolbar-section">
            <h1>TSIC Level Editor</h1>
        </div>

        <div class="toolbar-section" id="project-selector-section">
            <label for="project-dropdown">Project:</label>
            <select id="project-dropdown">
                <option value="">New Project...</option>
            </select>
            <div id="project-loading-spinner" class="loading-spinner" style="display: none;"></div>
            <input type="text" id="project-name-input" placeholder="Enter project name..." style="display: none;" aria-label="Project name">
            <button id="btn-create-project" style="display: none;">Create</button>
            <button id="btn-cancel-new-project" style="display: none;">Cancel</button>
        </div>

        <div class="toolbar-section">
            <button id="btn-new" title="New Project">New</button>
            <button id="btn-import" title="Import Level from JSON">Import</button>
            <button id="btn-export" title="Export Level to JSON">Export</button>
            <button id="btn-save-as" title="Save current project with a new name">Save As</button>
            <button id="btn-delete-project" title="Delete Current Project" style="display: none;">Delete</button>
            <button id="btn-generate-random-open" title="Generate Random World">Generate Random</button>
            <input type="file" id="file-input" accept=".json" style="display: none;" aria-label="Import file">
        </div>

        <div class="toolbar-section">
            <label for="grid-size-select">Grid Size:</label>
            <select id="grid-size-select">
                <option value="256" selected>256√ó256</option>
                <option value="512">512√ó512</option>
                <option value="1024">1024√ó1024</option>
            </select>
            <button id="btn-resize-grid">Apply</button>
        </div>

        <div class="toolbar-section">
            <span class="toolbar-label">Zoom:</span>
            <button id="btn-zoom-out">-</button>
            <span id="zoom-level">100%</span>
            <button id="btn-zoom-in">+</button>
            <button id="btn-zoom-fit">Fit</button>
        </div>

        <div class="toolbar-section">
            <label>
                <input type="checkbox" id="show-grid" checked>
                Show Grid
            </label>
        </div>

        <div class="toolbar-section">
            <label>
                <input type="checkbox" id="show-guides" checked>
                Guide Lines
            </label>
            <label for="guide-horizontal" style="margin-left: 10px;">H:</label>
            <input type="number" id="guide-horizontal" min="1" max="10" value="2" style="width: 40px;">
            <label for="guide-vertical" style="margin-left: 5px;">V:</label>
            <input type="number" id="guide-vertical" min="1" max="10" value="2" style="width: 40px;">
        </div>
    </div>

    <!-- Tool Options Bar -->
    <div id="tool-options">
        <!-- Fixed section: Undo/Redo -->
        <div class="option-group option-fixed">
            <button id="btn-undo" title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
            <button id="btn-redo" title="Redo (Ctrl+Y)">‚Ü∑ Redo</button>
        </div>

        <div class="option-divider"></div>

        <!-- Context-sensitive options -->
        <div class="option-group" id="brush-size-options" style="display: none;">
            <label for="brush-size" id="brush-size-label">Brush Size: 1</label>
            <input type="range" id="brush-size" min="1" max="50" value="1" style="width: 120px;">
        </div>

        <div class="option-group" id="brush-shape-options" style="display: none;">
            <span class="option-label">Shape:</span>
            <div class="segmented-control" id="brush-shape-control" role="group" aria-label="Brush shape">
                <button class="segment active" data-value="square">Square</button>
                <button class="segment" data-value="circle">Circle</button>
            </div>
        </div>

        <div class="option-group" id="shape-fill-options" style="display: none;">
            <label>
                <input type="checkbox" id="fill-mode" checked>
                Filled
            </label>
        </div>

        <div class="option-group" id="selection-actions" style="display: none;">
            <button id="btn-save-stamp" class="action-btn" title="Save Selection as Stamp">üíæ Stamp <kbd>Ctrl+Shift+S</kbd></button>
            <button id="btn-rotate" class="action-btn" title="Rotate 90¬∞ CW">‚Üª Rotate <kbd>R</kbd></button>
            <button id="btn-hflip" class="action-btn" title="Horizontal Flip">‚Üî H-Flip <kbd>H</kbd></button>
            <button id="btn-vflip" class="action-btn" title="Vertical Flip">‚Üï V-Flip <kbd>V</kbd></button>
        </div>

        <div class="option-group" id="wand-options" style="display: none;">
            <label>
                <input type="checkbox" id="wand-diagonal">
                Include Diagonals
            </label>
        </div>

        <div class="option-group" id="ruler-options" style="display: none;">
            <span id="ruler-measurement">Click and drag to measure</span>
        </div>

        <div class="option-spacer"></div>

        <div class="option-divider"></div>

        <div class="option-group option-fixed">
            <label for="layer-opacity" id="layer-opacity-label">Top Layer Opacity: 100%</label>
            <input type="range" id="layer-opacity" min="0" max="100" value="100" style="width: 120px;">
        </div>
    </div>

    <!-- Main Container -->
    <div id="main-container">
        <!-- Left Panel - Tools & Palette -->
        <div id="left-panel">
            <div class="panel-section">
                <h3>Tools</h3>
                <div id="tools">
                    <button class="tool-btn active" data-tool="pencil" title="Pencil (B)">
                        <span class="tool-icon">‚úèÔ∏è</span>
                        <span class="tool-name">Pencil (B)</span>
                    </button>
                    <button class="tool-btn" data-tool="bucket" title="Bucket Fill (G)">
                        <span class="tool-icon">ü™£</span>
                        <span class="tool-name">Bucket (G)</span>
                    </button>
                    <button class="tool-btn" data-tool="line" title="Line (L)">
                        <span class="tool-icon">üìè</span>
                        <span class="tool-name">Line (L)</span>
                    </button>
                    <button class="tool-btn" data-tool="rectangle" title="Shape (U)">
                        <span class="tool-icon">‚ñ≠</span>
                        <span class="tool-name">Shape (U)</span>
                    </button>
                    <button class="tool-btn" data-tool="eyedropper" title="Eyedropper (I)">
                        <span class="tool-icon">üíß</span>
                        <span class="tool-name">Picker (I)</span>
                    </button>
                    <button class="tool-btn" data-tool="eraser" title="Eraser (E)">
                        <span class="tool-icon">üßπ</span>
                        <span class="tool-name">Eraser (E)</span>
                    </button>
                    <button class="tool-btn" data-tool="pan" title="Pan (P)">
                        <span class="tool-icon">‚úã</span>
                        <span class="tool-name">Pan (P)</span>
                    </button>
                    <button class="tool-btn" data-tool="selection" title="Selection (M)">
                        <span class="tool-icon">‚¨ö</span>
                        <span class="tool-name">Select (M)</span>
                    </button>
                    <button class="tool-btn" data-tool="wand" title="Magic Wand (W)">
                        <span class="tool-icon">‚ú®</span>
                        <span class="tool-name">Wand (W)</span>
                    </button>
                    <button class="tool-btn" data-tool="stamp" title="Stamp (T)">
                        <span class="tool-icon">üîñ</span>
                        <span class="tool-name">Stamp (T)</span>
                    </button>
                    <button class="tool-btn" data-tool="ruler" title="Ruler (K)">
                        <span class="tool-icon">üìê</span>
                        <span class="tool-name">Ruler (K)</span>
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h3>Color Palette</h3>
                <div id="current-color-display">
                    <div id="current-color" style="background-color: #7CFC00;"></div>
                    <div id="current-color-label">None Selected</div>
                </div>
                <div id="color-lock-controls">
                    <button id="btn-lock-poi" title="Lock all Points of Interest">Lock POI</button>
                    <button id="btn-unlock-all" title="Unlock all colors">Unlock All</button>
                </div>
                <div id="palette-tabs">
                    <button class="palette-tab active" data-tab="biomes">Biomes</button>
                    <button class="palette-tab" data-tab="poi">POI</button>
                    <button class="palette-tab" data-tab="other">Other</button>
                </div>
                <div id="color-search-container">
                    <input type="text" id="color-search" placeholder="Search colors..." autocomplete="off" aria-label="Search colors">
                    <button id="color-search-clear" title="Clear search">√ó</button>
                </div>
                <div id="color-palette">
                    <!-- Colors loaded from config -->
                </div>
            </div>

            <div class="panel-section">
                <h3>Statistics</h3>
                <div id="statistics">
                    <div class="stat-row">
                        <span>Tiles:</span>
                        <span id="stat-tiles">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Empty:</span>
                        <span id="stat-empty">65536</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3>Copy History</h3>
                <div id="copy-history">
                    <div class="copy-history-empty">No copies yet</div>
                </div>
            </div>

            <div class="panel-section">
                <h3>Stamps</h3>
                <button id="btn-open-stamps" class="stamps-button">Open Stamp Picker</button>
                <div id="stamps-preview">
                    <div class="stamps-empty">No stamp selected</div>
                </div>
            </div>
        </div>

        <!-- Center Panel - Canvas -->
        <div id="center-panel">
            <div id="canvas-container">
                <canvas id="grid-canvas"></canvas>
                <canvas id="preview-canvas"></canvas>
            </div>
        </div>

        <!-- Right Panel - Layers -->
        <div id="right-panel">
            <!-- Minimap -->
            <div id="minimap-section" class="panel-section">
                <h3>Minimap</h3>
                <div id="minimap-container">
                    <canvas id="minimap-canvas"></canvas>
                </div>
            </div>

            <div class="panel-section">
                <h3>Layers</h3>
                <div id="layers-list">
                    <!-- Layers loaded from config -->
                </div>
            </div>

            <!-- Maze Visualizer Panel -->
            <div class="panel-section">
                <h3>Maze Visualizer</h3>

                <!-- Layer Toggle Buttons -->
                <div class="control-group">
                    <span class="control-label">Select Layer:</span>
                    <div class="segmented-control" id="maze-layer-control" role="group" aria-label="Layer selection">
                        <button class="segment" data-layer="floor">Floor</button>
                        <button class="segment" data-layer="underground">Underground</button>
                        <button class="segment" data-layer="sky">Sky</button>
                    </div>
                </div>

                <!-- Visualizer Content (shown when layer selected) -->
                <div id="maze-visualizer-content" style="display: none;">

                    <!-- Visualization Mode -->
                    <div class="control-group">
                        <label for="maze-viz-mode">Mode:</label>
                        <select id="maze-viz-mode" class="control-select">
                            <option value="regions" selected>Flood Fill Regions</option>
                            <option value="arrows">Maze Directions (Arrows)</option>
                            <option value="walls">Maze Walls</option>
                            <option value="connections">Connection Lines</option>
                        </select>
                    </div>

                    <!-- Settings Collapsible Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" id="maze-settings-header">
                            <span>Settings</span>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="maze-settings-content">

                            <!-- Border Biomes -->
                            <div class="control-group">
                                <span class="control-label">Border Biomes:</span>
                                <div id="maze-border-biomes" class="checkbox-group" role="group" aria-label="Border biomes">
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="Biome_Blocked" checked> Blocked
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="Biome_Pit" checked> Pit
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="Biome_SkyCeiling" checked> Sky Ceiling
                                    </label>
                                </div>
                            </div>

                            <!-- Max Height Difference -->
                            <div class="control-group">
                                <label for="maze-height-diff">Max Height Diff:</label>
                                <input type="number" id="maze-height-diff" class="control-input" min="0" max="64" value="1">
                                <span class="control-hint">Adjacent tiles must differ by ‚â§ this value</span>
                            </div>

                            <!-- Seed -->
                            <div class="control-group">
                                <label for="maze-seed">Seed:</label>
                                <input type="number" id="maze-seed" class="control-input" value="12345">
                            </div>

                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="control-group">
                        <button id="btn-regenerate-maze" class="control-button">Regenerate</button>
                        <button id="btn-export-maze-data" class="control-button">Export JSON</button>
                    </div>

                    <!-- Statistics -->
                    <div class="stats-container" id="maze-stats" style="display: none;">
                        <h4>Statistics</h4>
                        <div id="maze-stats-content"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Stamp Picker Modal -->
    <div id="stamp-picker-modal" class="modal">
        <div class="modal-content stamp-picker-content">
            <div class="modal-header">
                <h2>Stamp Picker</h2>
                <button class="modal-close" id="stamp-picker-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="stamp-picker-filter">
                    <span>Showing stamps for layer: </span>
                    <strong id="stamp-picker-layer-name">Floor</strong>
                </div>
                <div id="stamp-picker-grid">
                    <div class="stamps-empty">No stamps saved for this layer type</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Random Generation Panel (floating) -->
    <div id="random-gen-panel" class="floating-panel random-gen-panel" style="display: none;">
        <div class="panel-header">
            <h4>Generate Random World</h4>
            <button id="random-gen-close" class="close-button">√ó</button>
        </div>
        <div class="generation-presets">
            <select id="generation-preset-select" title="Select a preset to load">
                <option value="">-- Select Preset --</option>
            </select>
            <button id="btn-save-preset" title="Save current settings as new preset">Save As</button>
            <button id="btn-delete-preset" title="Delete selected preset">Delete</button>
        </div>
        <div id="random-gen-content" class="panel-content">
            <div class="random-gen-info">
                <p>Configure noise parameters for each layer. Uncheck layers to skip them during generation.</p>
            </div>
            <div id="random-gen-layers">
                <!-- Layer settings will be generated by JavaScript -->
            </div>
        </div>
        <div class="random-gen-footer">
            <div class="random-gen-global">
                <label for="random-gen-seed">Seed:</label>
                <input type="number" id="random-gen-seed" value="0" title="0 = random seed">
                <button id="btn-randomize-seed" title="Generate random seed">üé≤</button>
            </div>
            <button id="btn-generate-random" class="primary-button">Generate World</button>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar">
        <span id="status-position">X: 0, Y: 0</span>
        <span id="status-hover-info"></span>
        <span id="status-filename">No project loaded</span>
        <span id="status-message">Ready</span>
        <span id="status-autosave"></span>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/color-mapper.js"></script>
    <script src="js/layers.js"></script>
    <script src="js/rle-encoder.js"></script>
    <script src="js/rle-validator.js"></script>
    <script src="js/dynamic-validator.js"></script>
    <script src="js/tools.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/validation.js"></script>
    <script src="js/export-png.js"></script>
    <script src="js/export-metadata.js"></script>
    <script src="js/perlin-noise.js"></script>
    <script src="js/base64-rle-encoder.js"></script>
    <script src="js/maze-algorithms.js"></script>
    <script src="js/maze-visualizer.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
